<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ検索 (LLM搭載)</title>
    <style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.6;margin:0;padding:20px;background-color:#f9f9f9;color:#333}.container{max-width:800px;margin:0 auto;background-color:#fff;padding:20px 30px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.08);min-height:400px}h1,h2{text-align:center;color:#2c3e50}h2{font-size:1.2em;margin-top:40px;border-bottom:2px solid #f0f0f0;padding-bottom:10px}#search-form{display:flex;gap:10px;margin-bottom:15px}#search-box{flex-grow:1;padding:15px;border:1px solid #ddd;border-radius:8px;font-size:16px}#search-button{padding:15px 20px;border:none;background-color:#3498db;color:#fff;border-radius:8px;cursor:pointer;font-size:16px}#search-button:disabled{background-color:#95a5a6}#search-results,#top-faq-list{max-height:50vh;overflow-y:auto;padding-left:0;list-style:none}.result-item,.top-faq-item{padding:15px;border-bottom:1px solid #eee;cursor:pointer;transition:background-color .2s}.result-item:hover,.top-faq-item:hover{background-color:#f2f8fc}.result-item:last-child,.top-faq-item:last-child{border-bottom:none}.result-item p,.top-faq-item p{margin:0;color:#555}.result-item p:first-child,.top-faq-item p:first-child{font-weight:700}.result-item p:last-child{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#back-button{background:0 0;border:1px solid #ccc;color:#555;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:14px;margin-bottom:20px}#details-question{font-size:1.4em;font-weight:700;color:#2c3e50;margin-bottom:15px}#details-question::before{content:"Q. "}#details-answer{background-color:#fdfdfd;border-left:4px solid #3498db;padding:15px 20px;margin-bottom:20px;white-space:pre-wrap}.details-image{max-width:100%;height:auto;border-radius:5px;margin-top:10px;border:1px solid #eee}.hidden{display:none}#loading-message,#no-results-message,#search-status{text-align:center;color:#888;padding:20px 0}</style>
</head>
<body>
    <div class="container">
        <h1>FAQ検索</h1>
        <div id="top-faq-area" class="hidden">
            <h2>よく見られている質問</h2>
            <div id="top-faq-list"></div>
        </div>
        <div id="search-area" class="hidden">
            <h2>質問を入力してください</h2>
            <form id="search-form">
                <input type="text" id="search-box" placeholder="例：登録情報の変更方法">
                <button type="submit" id="search-button">検索</button>
            </form>
            <div id="search-status"></div>
        </div>
        <div id="details-area" class="hidden">
            <button id="back-button">← 戻る</button>
            <div id="details-content"></div>
        </div>
        <div id="loading-message"><p>データを読み込み中です...</p></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // あなたのURLに書き換えてください
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjoQQrCTGeKMVSIhVUqwm_kbybGXIrxw5nMdNmfcfv_1RQRTU7DnOyATz_nKgf5qsG__zyeWpgI8dY/pub?output=csv';
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyNyRNKM22LDD3M1ciC2toFaUuSxPwEdsXHuyIpSsBAkhvMjfsY599CfsmwVYKF6_xb/exec'; // 新しいURLでも古いURLでも、最後にデプロイした方

        // ... (要素取得やヘルパー関数は変更なし) ...
        const topFaqArea = document.getElementById('top-faq-area');
        const searchArea = document.getElementById('search-area');
        const detailsArea = document.getElementById('details-area');
        const searchForm = document.getElementById('search-form');
        const searchBox = document.getElementById('search-box');
        const searchButton = document.getElementById('search-button');
        const searchStatus = document.getElementById('search-status');
        const topFaqList = document.getElementById('top-faq-list');
        const detailsContent = document.getElementById('details-content');
        const backButton = document.getElementById('back-button');
        const loadingMessage = document.getElementById('loading-message');
        let faqData = [];
        const transformImageUrl = (url) => { if (url.includes('imgur.com')) { return url; } const regex = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/; const match = url.match(regex); return (match && match[1]) ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url; };
        const parseCsvRow = (row) => { const result = []; const regex = /("([^"]|"")*"|[^,]*)(,|$)/g; row += ','; let match; while ((match = regex.exec(row))) { let value = match[1] || ''; if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1).replace(/""/g, '"'); result.push(value); if (match[3] === '') break; } return result; };

        // ... (データ読み込みロジックは変更なし) ...
        fetch(SPREADSHEET_URL + '&cache_bust=' + new Date().getTime())
            .then(response => { if (!response.ok) throw new Error('スプレッドシートのデータ読み込みエラー: ' + response.status); return response.text(); })
            .then(csvText => {
                const rows = csvText.trim().split(/\r?\n/).slice(1);
                faqData = rows.map((row, index) => { if (!row.trim()) return null; const columns = parseCsvRow(row); return { id: index, question: columns[0] || '', answer: columns[1] || '', imageUrl: columns[2] || '', count: parseInt(columns[3] || '0') }; }).filter(item => item && item.question);
                loadingMessage.classList.add('hidden');
                topFaqArea.classList.remove('hidden');
                searchArea.classList.remove('hidden');
                displayTopFaqs();
            })
            .catch(error => { loadingMessage.innerHTML = `<p style="color: red;">初期化エラー: ${error.message}</p>`; });
        
        // ... (トップFAQ表示ロジックは変更なし) ...
        const displayTopFaqs = () => { topFaqList.innerHTML = ''; const sortedFaqs = [...faqData].sort((a, b) => b.count - a.count); const top5 = sortedFaqs.slice(0, 5); top5.forEach(item => { if (item.count === 0 && top5.length > 1) return; const itemDiv = document.createElement('div'); itemDiv.className = 'top-faq-item'; itemDiv.dataset.id = item.id; itemDiv.innerHTML = `<p>${item.question}</p>`; itemDiv.addEventListener('click', () => showFaqDetails(item.id)); topFaqList.appendChild(itemDiv); }); };
        
        // LLM検索実行
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchBox.value.trim();
            if (!query) return;

            searchStatus.textContent = '最適な回答を検索中...';
            searchButton.disabled = true;

            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                // ▼▼▼▼▼ ここが最重要の修正点 ▼▼▼▼▼
                // 'application/json' ではなく 'text/plain' にすることで、プリフライトリクエストを回避する
                headers: { 'Content-Type': 'text/plain' },
                // ▲▲▲▲▲ ここが最重要の修正点 ▲▲▲▲▲
                body: JSON.stringify({ query: query })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                const bestMatch = faqData.find(faq => faq.id === data.bestMatchId);
                if (bestMatch) {
                    showFaqDetails(bestMatch.id);
                } else {
                    searchStatus.textContent = '最適な回答が見つかりませんでした。';
                }
            })
            .catch(err => {
                console.error('Search failed:', err);
                searchStatus.textContent = `検索エラー: ${err.message}`;
            })
            .finally(() => {
                searchButton.disabled = false;
                setTimeout(() => { searchStatus.textContent = ''; }, 4000);
            });
        });

        // ... (詳細表示とUI切り替え関数は変更なし) ...
        const showFaqDetails = (id) => { const item = faqData.find(d => d.id === id); if (!item) return; fetch(`${GAS_WEB_APP_URL}?index=${item.id}`).catch(err => console.error("Count-up fetch error:", err)); const clickedItem = faqData.find(faq => faq.id === id); if (clickedItem) clickedItem.count++; const imageHtml = item.imageUrl ? `<img src="${transformImageUrl(item.imageUrl)}" alt="関連画像" class="details-image">` : ''; detailsContent.innerHTML = `<div class="details-question">${item.question}</div><div class="details-answer">${item.answer}</div>${imageHtml}`; showDetailsArea(); };
        const showMainPage = () => { detailsArea.classList.add('hidden'); topFaqArea.classList.remove('hidden'); searchArea.classList.remove('hidden'); displayTopFaqs(); };
        const showDetailsArea = () => { topFaqArea.classList.add('hidden'); searchArea.classList.add('hidden'); detailsArea.classList.remove('hidden'); };
        backButton.addEventListener('click', showMainPage);
    });
    </script>
</body>
</html>
